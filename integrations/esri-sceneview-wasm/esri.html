<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="origin-trial" content="AvcnlD3Jh74eZ6jq82HUr96gI1vygNstBwiSJAdv9I4zH+0grab5BJHIjLVz2QoZWgpgp+yKFnX7Iyhhd5IJSgkAAAB7eyJvcmlnaW4iOiJodHRwczovL3d3dy5ldWNsaWRlb24uY29tOjQ0MyIsImZlYXR1cmUiOiJVbnJlc3RyaWN0ZWRTaGFyZWRBcnJheUJ1ZmZlciIsImV4cGlyeSI6MTYzOTUyNjM5OSwiaXNTdWJkb21haW4iOnRydWV9">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>udSDK Esri Demo</title>

    <link rel="stylesheet" href="https://samples.euclideon.com/api/arcgisjs/4.24/esri/themes/light/main.css" crossorigin />
    <script src="https://samples.euclideon.com/api/arcgisjs/4.24/init.js" crossorigin></script>

    <style>
      html, body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #viewDiv {
        display: flex;
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        flex-wrap: wrap;
        justify-content: space-evenly;
        align-items: stretch;
      }

      .viewPortal {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #loginBox {
        position: absolute;
        bottom: 18px;
        right: 12px;
        padding: 12px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        display: none;
      }
    </style>

    <!-- A simple fragment shader -->
    <script id="shader-fs" type="x-shader/x-fragment">#version 300 es
      precision mediump float;
      precision highp int;
      
      //Input Format
      in highp vec2 v_uv;

      uniform sampler2D u_texture;
      uniform sampler2D u_depth;
      
      layout(location = 0) out highp vec4 out_var_SV_Target0;

      void main()
      {
        vec4 col = texture(u_texture, v_uv);
        float depth = texture(u_depth, v_uv).x;

        out_var_SV_Target0 = vec4(col.zyx, 0.5);
        gl_FragDepth = depth * 0.5 + 0.5;
      }
    </script>

    <!-- A simple vertex shader -->
    <script id="shader-vs" type="x-shader/x-vertex">#version 300 es
      in vec2 aVertexPosition;
      in vec2 aVertexUVs;
      uniform sampler2D u_texture;

      out vec2 v_uv;

      // A magenta color for referencing
      // Refer to line 311 to 315, we set a point to magenta color.
      // And we will compare the magenta point with this vec4 magenta.
      vec4 magenta = vec4(1.0, 0.0, 1.0, 1.0);
      vec4 topLeft;

      void main(void) {
        // Correction work
        topLeft = texture(u_texture, vec2(0.0, 0.0));
        // We want to check if the magenta point is rendered in top left corner
        // If not, flip it
        if (topLeft == magenta)
          v_uv = vec2(aVertexUVs.x, aVertexUVs.y);
        else
          v_uv = vec2(aVertexUVs.x, 1.0 - aVertexUVs.y);
        gl_Position = vec4(aVertexPosition.xy, 0.0, 1.0);
      }
    </script>

    <!-- Our application -->
    <script>
      var udSDKJSReady = false;

      require([
        "esri/Map",
        "esri/views/SceneView",
        "esri/views/3d/externalRenderers",
        "esri/widgets/Home",
        "esri/widgets/Search"
      ], function(
        Map,
        SceneView,
        externalRenderers,
        Home,
        Search
      ) {
        // Set up the external renderer
        var udSDKRenderer = {
          // Input data
          view: null,
          prevWidth: 0,
          prevHeight: 0,

          // Vertex and index buffers
          vbo: null,
          texture: null,
          textureDepth: null,

          // Shader
          program: null,

          // Shader attribute and uniform locations
          programAttribVertexPosition: null,
          programAttribVertexTexture: null,

          textureLocation: null,
          textureLocationDepth: null,

          // Temporary matrices and vectors,
          // used to avoid allocating objects in each frame.
          tempMatrix4: new Float32Array(16),
          tempMatrix3: new Float32Array(9),
          tempVec3: new Float32Array(3),

          /**
           * Constructor
           */
          constructor: function(view) {
            this.view = view3D;
          },

          /**
           * Called once after this external renderer is added to the scene.
           * This is part of the external renderer interface.
           */
          setup: function(context) {
            this.initShaders(context);

            this.prevWidth = context.camera.width;
            this.prevHeight = context.camera.height;

            var gl = context.gl;

            this.vbo = context.gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, this.vbo);

            var vertData = new Float32Array([-1,-1,0,1,  1,-1,1,1,  1,1,1,0, -1,-1,0,1,  1,1,1,0,  -1,1,0,0]);
            gl.bufferData(gl.ARRAY_BUFFER, vertData, gl.STATIC_DRAW);

            var position = gl.getAttribLocation(this.program, "aVertexPosition");
            gl.vertexAttribPointer(position, 2, gl.FLOAT, false, 16, 0);
            gl.enableVertexAttribArray(position);

            var texCoord = gl.getAttribLocation(this.program, "aVertexUVs");
            gl.vertexAttribPointer(texCoord, 2, gl.FLOAT, false, 16, 8);
            gl.enableVertexAttribArray(texCoord);

            var data = new Uint8Array(4);
            data[0] = data[1] = data[2] = data[3] = 255;

            this.texture = gl.createTexture();
            gl.bindTexture (gl.TEXTURE_2D, this.texture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, data);

            var dataF32 = new Float32Array(1);
            dataF32[0] = 0.0;

            this.textureDepth = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, this.textureDepth);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.R32F, 1, 1, 0, gl.RED, gl.FLOAT, dataF32);
          },

          /**
           * Called each time the scene is rendered.
           * This is part of the external renderer interface.
           */
          render: function(context) {
            var gl = context.gl;

            gl.enable(gl.DEPTH_TEST);
            gl.disable(gl.CULL_FACE);
            gl.disable(gl.BLEND);

            gl.useProgram(this.program);
            gl.uniform1i(this.textureLocation, 0);
            gl.uniform1i(this.textureLocationDepth, 1);

            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, this.texture);

            gl.activeTexture(gl.TEXTURE1);
            gl.bindTexture(gl.TEXTURE_2D, this.textureDepth);

            var width = context.camera.width;
            var height = context.camera.height;

            if (udSDKJSReady)
            {
              if (width != this.prevWidth || height != this.prevHeight)
              {
                this.prevWidth = width;
                this.prevHeight = height;

                var data = new Uint8Array(width*height*4);
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, this.texture);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, data);

                var dataF32 = new Float32Array(width*height);
                gl.activeTexture(gl.TEXTURE1);
                gl.bindTexture(gl.TEXTURE_2D, this.textureDepth);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.R32F, width, height, 0, gl.RED, gl.FLOAT, dataF32);

                udSDKJS_ResizeScene(width, height, 0, 0);
              }

              var v = context.camera.viewMatrix;
              udSDKJS_SetMatrix("view", v[0],v[1],v[2],v[3],v[4],v[5],v[6],v[7],v[8],v[9],v[10],v[11],v[12],v[13],v[14],v[15]);

              var v = context.camera.projectionMatrix;
              udSDKJS_SetMatrix("projection", v[0],v[1],v[2],v[3],v[4],v[5],v[6],v[7],v[8],v[9],v[10],v[11],v[12],v[13],v[14],v[15]);

              udSDKJS_RenderQueue();

              var ptr = udSDKJS_GetColourBuffer();
              var data = new Uint8Array(HEAPU8.subarray(ptr, ptr+(width*height*4)));
              // Magenta point
              data[0] = 255;
              data[1] = 0;
              data[2] = 255;
              data[3] = 255;

              gl.activeTexture(gl.TEXTURE0);
              gl.bindTexture(gl.TEXTURE_2D, this.texture);
              gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, data);

              var ptr = udSDKJS_GetDepthBuffer();
              var dataHeapF32 = new Float32Array(HEAPF32.subarray(ptr>>2, (ptr+(width*height*4))>>2));

              gl.activeTexture(gl.TEXTURE1);
              gl.bindTexture(gl.TEXTURE_2D, this.textureDepth);
              gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, width, height, gl.RED, gl.FLOAT, dataHeapF32);

              gl.bindBuffer(gl.ARRAY_BUFFER, this.vbo);

              var position = gl.getAttribLocation(this.program, "aVertexPosition");
              gl.vertexAttribPointer(position, 2, gl.FLOAT, false, 16, 0);
              gl.enableVertexAttribArray(position);

              var texCoord = gl.getAttribLocation(this.program, "aVertexUVs");
              gl.vertexAttribPointer(texCoord, 2, gl.FLOAT, false, 16, 8);
              gl.enableVertexAttribArray(texCoord);

              gl.drawArrays(gl.TRIANGLES, 0, 6);
            }

            // Draw continuously
            externalRenderers.requestRender(view3D);

            // cleanup
            context.resetWebGLState();
          },

          /**
           * Loads a shader from a <script> html tag
           */
          getShader: function(gl, id) {
            var shaderScript = document.getElementById(id);
            if (!shaderScript) {
              return null;
            }

            var str = "";
            var k = shaderScript.firstChild;
            while (k) {
              if (k.nodeType == 3) {
                str += k.textContent;
              }
              k = k.nextSibling;
            }

            var shader;
            if (shaderScript.type == "x-shader/x-fragment") {
              shader = gl.createShader(gl.FRAGMENT_SHADER);
            } else if (shaderScript.type == "x-shader/x-vertex") {
              shader = gl.createShader(gl.VERTEX_SHADER);
            } else {
              return null;
            }

            gl.shaderSource(shader, str);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
              alert(gl.getShaderInfoLog(shader));
              return null;
            }

            return shader;
          },

          /**
           * Links vertex and fragment shaders into a GLSL program
           */
          linkProgram: function(gl, fragmentShader, vertexShader) {
            var shaderProgram = gl.createProgram();

            gl.attachShader(shaderProgram, vertexShader);
            gl.attachShader(shaderProgram, fragmentShader);
            gl.linkProgram(shaderProgram);

            if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
              return null;
            }

            return shaderProgram;
          },

          /**
           * Initializes all shaders requried by the application
           */
          initShaders: function(context) {
            var gl = context.gl;

            var fragmentShader = this.getShader(gl, "shader-fs");
            var vertexShader = this.getShader(gl, "shader-vs");
            this.program = this.linkProgram(gl, fragmentShader, vertexShader);
            if (!this.program) {
              alert("Could not initialise shaders");
            }

            this.textureLocation = gl.getUniformLocation(this.program, "u_texture");
            this.textureLocationDepth = gl.getUniformLocation(this.program, "u_depth");
          }
        };

        // Create the map and view
        var map = new Map({
          basemap: "streets",
          //basemap: "hybrid",
          ground: "world-elevation"
        });

        var view3D = new SceneView({
          container: "view3D",
          map: map,
          viewingMode: "global",
          camera: {
            position: {
              x: 16136507.580070,
              y: -4556368.260251,
              z: 348.61,
              spatialReference: { wkid: 102100 }
            },
            heading: 20,
            tilt: 85
          }
        });

        var homeBtn = new Home({
          view: view3D
        });

        var search = new Search({
          view: view3D
        });

        // Add the home button to the top left corner of the view
        view3D.ui.add(homeBtn, "top-left");
        view3D.ui.add(search, "top-right");

        // Install our external renderer
        externalRenderers.add(view3D, udSDKRenderer);
      });
    </script>
  </head>

  <body>
    <script>
      const udSDKjs = document.createElement('script');
      udSDKjs.src = './euclideon/udSDKjs.js';
      document.body.appendChild(udSDKjs);

      const easyudSDKjs = document.createElement('script');
      easyudSDKjs.src = './euclideon/easyudSDKjs.js';
      document.body.appendChild(easyudSDKjs);
    </script>
    <div id="viewDiv">
      <div id="view3D" class="viewPortal"></div>
    </div>
    <div id="loginBox">
        <span id="errorMessage" style="color: red;"></span>
    </div>
    <script>
      function udSDKInit()
      {
        udSDKJS_RegisterShared();

        var status = udSDKJS_CreateSharedFrom_udCloud("Esri ArcScene").then(
          function() {
            // LiDAR of Melbourne available as [Open Data](https://data.melbourne.vic.gov.au/City-Council/City-of-Melbourne-3D-Point-Cloud-2018/).
            udSDKJS_LoadModel("https://models.euclideon.com/Melbourne_75mm.uds").then(
              function(modelHandle) {
                console.log(udSDKJS_GetErrorString(udSDKJS_RenderQueueAddModel(modelHandle, 150.0, -1)));
              }, function(code) {
                console.log(udSDKJS_GetErrorString(code));
              }
            );

            // LiDAR of Vancouver available as [Open Data](https://opendata.vancouver.ca/pages/home/).
            udSDKJS_LoadModel("https://models.euclideon.com/Vancouver_Colour.uds").then(
              function(modelHandle) {
                console.log(udSDKJS_GetErrorString(udSDKJS_RenderQueueAddModel(modelHandle, 227.0, -1)));
              }, function(code) {
                console.log(udSDKJS_GetErrorString(code));
              }
            );

            udSDKJSReady = true;
            document.getElementById("loginBox").style.display = "none"; // Hide this if it was presented previously
          },
          function(code) {
            document.getElementById("loginBox").style.display = "block";
            if (code == 13)
              document.getElementById("errorMessage").innerText = "udSDKJS Error / Email or Password Wrong";
            else
              document.getElementById("errorMessage").innerText = "udSDKJS FAILED Error=" + code;
          }
        );
      }

      var Module = {
        noExitRuntime: true,
        preRun: [],
        postRun: udSDKInit,
        setStatus: function(text) {
          if (!Module.setStatus.last)
            Module.setStatus.last = { time: Date.now(), text: '' };

          if (text === Module.setStatus.last.text)
            return;

          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30)
            return; // if this is a progress update, skip it if too soon

          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
          }

          console.log(text);
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };

      Module.setStatus('Downloading...');
    </script>
  </body>
</html>
